<!DOCTYPE html>
<html>
  <head>
    <title>Microservices and Docker</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Oxygen);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Oxygen';
        font-weight: bold;
      }
      h5 {
        -webkit-margin-after: -0.8em;
      }
      .remark-code { font-size: 14px; }
      .small { font-size: 12px; }
      .large .remark-code { font-size: 18px; }
      .row { display: flex; align-items: center; width: 70%; margin: auto; }
      .col { flex: 1; margin: 10px; }
      .image img { width: 100%; height: auto; }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }

      .fox-image img { width: 60%; height: auto }
      /* Two-column layout */
      .left-column {
        color: #777;
        width: 15%;
        height: 92%;
        float: left;
      }
      .left-column h4:last-of-type, .left-column h4:last-child {
        color: #000;
      }

      .right-column {
        width: 75%;
        float: right;
        padding-top: 0;
      }
      .quote {
        margin: auto;
        padding: 15px 10px;
        background-color: #eee;
        font-style: italic;
        text-align: center;
        font-size: 1.2em;
        width: 70%;
      }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

.fox-image[
![Fox DCG](images/fox-dcg-logo-updated.png)
]

# Microservices and Docker

#### Brian DeBoer
.row[
.col[.image[
![Fox](images/docker-logo.png)
]]
.col[.image[
![FX](images/consul-logo.png)
]]
.col[.image[
![FX](images/lerna-logo.png)
]]
.col[.image[
![FX](images/terraform-logo.png)
]]
]

---
# Who is FOX DCG
.row[
.col[.image[
![Fox](images/fox-logo.png)
]]
.col[.image[
![FX](images/fx-logo.png)
]]
.col[.image[
![National Geographic](images/nat-geo-logo.png)
]]
.col[.image[
![FOX Sports](images/fox-sports-logo.png)
]]
]

- Responsible for consumer video applications across FOX, FOX Sports, FX, and National Geographic, ie. FOXNOW, FXNOW, etc...

- Build APIs and services for client applications across all platforms

### About me

- At FOX 1.5 years, at Disney/ABC before that almost 10 years.

- Background as a full stack developer.


---
class: center, middle
## docker !== microservices
#### Docker is a piece of our microservice puzzle
---
name: goals0
### Goals

#### Microservices have to follow a set of rules and structures to be succesful
- Microservices have to know how to communicate with one another. Having a standard API format is crucial.

- Microservices have to know how to find each other.

- Have to be aware that more they may have more than one consumer.

---
name: goals1
### Goals

#### Content/Data management (CMS) needs to be based on the same services as the client apps.
 - Client (iOS/Android app/etc...) always sees the same thing as the editor in the CMS.
 So CMS is really just a React/Redux front end for the same services that the client app uses.

 - Data can be sourced can be from a variety of places, each with different levels of quality or rules.
 So we need a way to translate or update the content before it is used.

 - Ability to override a single field on any platform but still inherit other fields.

 - Need to have different layers of APIs. General apis and BFF (Backends for Frontends) apis.
---
## TODO: insert diagram here
---
name: goals2
### Goals

#### Documentation needs to be simple and based on code.
 - Documentation is time consuming and will always get out of sync with code. So make it based on the code.

 - Exceptions happen so framework needs to be flexible to match.

 - Use Hypermedia driven web APIs, so that the apis are discoverable.

 - Products like apigee127 take similar but opposite approach.

---
name: models
##### Sample model:
```js
const SeriesModel = new Schema({
  approved: {
    type: Boolean,
  },
  contentFlags: {
    type: [String],
  },
  fullEpisodeCount: {
    type: Number,
  },
  previewVideo: {
    type: Collection,
    ref: 'Video',
    fields: ['@id', '@type', 'playerScreenUrl'],
  },
});
```

##### Sample draft (in) translation:
```js
class SeriesDraftTranslation extends Translation {
  contentFlags() {
    _.uniq(this._all('contentFlags').map(x => x.toLowerCase());
  }
}
```

##### Sample published (out) translation:
```js
class SeriesPublishedTranslation extends Translation {
  approved() {
    return this._get('cms.approved') && this._any('restriced') === false;
  }

  fullEpisodeCount() {
    return Video.count({ showId: this.id });
  }
}
```
---
name: swagger
##### Generates swagger
```json
{
  "swagger": "2.0",
  ...
  "paths": {
    "/series": {
      "get": {
        "produces": ["application/json"],
        "parameters": [{
          "name": "approved",
          "in": "query",
          "required": false,
          "type": "boolean"
        },
        ...
        "responses": "200": {
          "description": "Collection of Series objects",
          "headers": {
            ...
          },
          "schema": {
            "$ref": "#/definitions/SeriesCollection"
          }
        },
      }
    },
  },
  "definitions": {
    "Series": {
      "type": "object",
      "properties": {
        "@id": {
          "type": "string"
        },
        "approved": {
          "type": "boolean"
        },
        ...
      }
    }
  }
}
```
---
name: response
##### Generates response
```json
{
  "@platform": "default",
  "@id": "/series",
  "@context": "/context/core.jsonld",
  "@type": "Collection",
  "@populated": false,
  "itemsPerPage": 25,
  "totalItems": 201,
  "member": [{
    "@id": "/series/13-going-on-30_2004",
    "@type": "Series",
    "approved": true,
    "contentFlags": ["new", "expiring soon"],
    "fullEpisodeCount": 12,
    "previewVideo": {
      "@type": "Collection",
      ...
      "member": [{
        "@id": "/video/622258f933fc7f979a4358bb22a62d32",
        "@type": "Video"
      }]
    }
  },
  ...
  ]
}
```
---
name: goals3
### Goals

#### Easy for developers to work with, replicate, and deploy
 - Need to be able to run the entire environment and all services locally.

 - Desire to use the same tools and tooling that we work with everyday, whether you are developing a service, deploying code, or
 changing the infrastructure.

 - Need to be able to stamp out multiple environments or alternate builds with minimal effort.

 - Reuse code when possible, but not at the expense of keeping separation of services.

---
name: docker
.left-column[.image[![Docker](images/docker-logo.png)]]
.right-column[
### Docker
  - Provides us with consistent deployment artifacts.

  - Leverage a library of already built docker images. No need to worry about how to install consul, redis, elasticsearch, etc...

  - Easily share configuration amongst developers.

  - Docker compose allows us to simulate the entire environment.

  - Really easy to utilize environment variables as switches.

  - Utilizes our resources more effectively. Run multiple microservices on a single instance.

  - With terraform we can spin up an entire stack of microservices very quickly for one off tests or separate tests.
  (more on this later)
]
---
name: sample-docker
##### Sample docker-compose.yml
```yml
version: "2"
services:
  service1:
    environment:
      SERVICE_NAME: "service1"
      SERVICE_8014_NAME: "service1-draft"
      SERVICE_8015_NAME: "service1-published"
      SERVICE_TAGS: "service1-path1,service1-path2"
    ports:
      - "8000:8000"
      - "8001:8001"
    depends_on:
      - es
      - mongo
  service2:
    environment:
      SERVICE_NAME: "service2"
      SERVICE_8012_NAME: "service2-draft"
      SERVICE_8013_NAME: "service2-published"
      SERVICE_TAGS: "service2-path1,service2-path2"
    ports:
      - "8002:8002"
      - "8003:8003"
    depends_on:
      - es
      - mongo
  mongo:
    build:
      context: ./docker/mongo
      dockerfile: Dockerfile
    image: mongo:3.4
    volumes:
      - ./docker/mongo/data:/data/db
    ports:
      - "27017:27017"
  es:
    ...
```
---
name: more-docker-samples
##### Sample docker-compose-override.yml
```yml
version: "2"
services:
  service1:
    extends:
      file: common.yml
      service: microservice
    ports:
      # debug ports
      - "7014:7000"
      - "7015:7001"
    volumes:
      - ./packages/service:/opt/app/service
```
##### Sample common.yml
```yml
version: "2"
services:
# shared microservices definitions
  microservice:
    image: service:local
    environment:
      NODE_ENV: "local"
    volumes:
      - ./packages/shared-package:/opt/app/shared-package
    mem_limit: 512m
```
---
name: lambda
### Why not use Lambda?

 - It is the future.

 - We still like to have visibility and full control of the application.

 - All of our code is actually built to work as a controller or as a handler function with Lambda so we can switch when ready.

 - When we started the local development and tooling wasn't quite ready.

---
name: lerna-pros
.left-column[.image[![Lerna](images/lerna-logo.png)]
#### What is it?
]
.right-column[
### Lerna and monorepos
#### What is a monorepo?
- A large _monolithic_ repository, aka monorepo.

- A repository that contains more than one project. In our case, all of our microservices and relevant files.


]
---
name: lerna-why
.left-column[.image[![Lerna](images/lerna-logo.png)]
#### What is it?
#### Why?
]
.right-column[
### Lerna and monorepos
#### Why would you do _that_?
 - Keeps dependencies together which simplifies managing the code.

 - Better sharing and knowledge of components.

 - Challenging to enforce standardization and tests of code across repositories. For example, eslintrc.

 - Code reviews happening across multiple repos and devs don't always look in more than one place.

 - PR's across multiple repositories results in chicken and egg scenarios.

 - Branching or new versions of code much easier to implement.

 - Intergration and e2e tests that leverage multiple services are much easier

 - Git submodules are complex and error-prone
]
---
name: lerna-cons
.left-column[.image[![Lerna](images/lerna-logo.png)]
#### What is it?
#### Why?
#### Cons
]
.right-column[
### Lerna and monorepos
#### What are the challenges of using a monorepo?
 - Most CI and CD tools are going to require some customization to streamline the build.

 - We want our docker containers to be small, so we can't stick the entire codebase into the image. That requires
 custom scripting to accomplish.

 - If you do that, then some code duplication might be necessary, but it's still possible to keep it limited.
]
---
name: lerna
### What is Lerna?
.quote[
Lerna is a tool that optimizes the workflow around managing multi-package repositories with git and npm.
]
#### Features:
- provides a structure to monorepos
```
lerna.json
package.json
packages/
 - shared_package/
 -   node_modules
 -   package.json
 - service1/
 -   node_modules
 -   package.json
 - service2/
 -   node_modules
 -   package.json
```
- provides an interface for publishing to npm, tagging in git, and semantic version control
---
name: lerna
### Lerna commands
.large[
```sh
# Bootstrap the packages in the current Lerna repo.
# Installing all their dependencies and linking any cross-dependencies.

> lerna bootstrap
```
]
.large[
```sh
# Create a new release of the packages that have been updated.
# Prompts for a new version and updates all the packages on git and npm.

> lerna publish

lerna info version 2.0.0-rc.4
lerna info current version undefined
lerna info Checking for updated packages...
lerna info Comparing with tag v0.0.3-b
? Select a new version (currently undefined) (Use arrow keys)
❯ Patch (null)
...
Changes:
 - @my_company/service1: 1.0.3 => 1.0.4
 - @my_company/service2: 1.0.3 => 1.0.4
 - @my_company/shared_package: 1.0.3 => 1.0.4
? Are you sure you want to publish the above changes? (ynH)
```
]
---
name: todo
## TODO

- create an architecture diagram
- show how the different services are used (who consumes them)
- Client apis. Need multiple paths… base level REST apis (for CMS) and high availability BFF apis (Backends for Frontends) Sam Newman

---
class: middle, center
## Questions?

brian.deboer@fox.com
    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create({
        // Set the slideshow display ratio
        // Default: '4:3'
        // Alternatives: '16:9', ...
        ratio: '16:9',
        highlightStyle: 'solarized-light',
        highlightSpans: true,
        // Navigation options
        navigation: {
          // Enable or disable navigating using scroll
          // Default: true
          // Alternatives: false
          scroll: false,

          // Enable or disable navigation using touch
          // Default: true
          // Alternatives: false
          touch: false,

          // Enable or disable navigation using click
          // Default: false
          // Alternatives: true
          click: false,
        }
      });
    </script>
  </body>
</html>
